---
import { paths } from "@awfe/paths";
import { z } from "astro/zod";
import { TvCategoryList } from "../../../components/infinite-lists/tv-category-list";
import MediaCardList from "../../../components/media-card-list.astro";
import { tmdb } from "../../../integrations/tmdb";
import Layout from "../../../layouts/layout.astro";

export const prerender = false;

const getData = async () => {
  const parseResult = await z
    .object({ name: z.string().min(1) })
    .safeParseAsync(Astro.params);

  if (!parseResult.success) {
    return null;
  }

  const context = tmdb.getTMDBContext();

  try {
    const name = parseResult.data.name;
    const tvs =
      name === "trending"
        ? await tmdb.getTrendingTv({ context, page: 1 })
        : await tmdb.getTvShows({ context, page: 1, query: name });
    return { name, tvs };
  } catch {
    return null;
  }
};

const data = await getData();

if (!data) {
  return Astro.redirect(paths.notFound);
}
---

<Layout>
  <TvCategoryList client:idle name={data.name} pageCount={data.tvs.total_pages}>
    <MediaCardList collection={data.tvs.results ?? []} />
  </TvCategoryList>
</Layout>
