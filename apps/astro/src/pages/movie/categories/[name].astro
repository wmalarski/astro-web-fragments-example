---
import { paths } from "@awfe/paths";
import { z } from "astro/zod";
import { MoviesCategoryList } from "../../../components/infinite-lists/movies-category-list";
import MediaCardList from "../../../components/media-card-list.astro";
import {
  getMovies,
  getTMDBContext,
  getTrendingMovie,
} from "../../../integrations/tmdb/services";
import Layout from "../../../layouts/layout.astro";

export const prerender = false;

const getData = async () => {
  const parseResult = await z
    .object({ name: z.string().min(1) })
    .safeParseAsync(Astro.params);

  if (!parseResult.success) {
    return null;
  }

  const context = getTMDBContext();

  try {
    const name = parseResult.data.name;
    const movies =
      name === "trending"
        ? await getTrendingMovie({ context, page: 1 })
        : await getMovies({ context, page: 1, query: name });
    return { movies, name };
  } catch {
    return null;
  }
};

const data = await getData();

if (!data) {
  return Astro.redirect(paths.notFound);
}
---

<Layout>
  <MoviesCategoryList name={data.name} pageCount={data.movies.total_pages}>
    <MediaCardList collection={data.movies.results ?? []} />
  </MoviesCategoryList>
</Layout>
