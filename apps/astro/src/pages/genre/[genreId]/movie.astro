---
import { paths } from "@awfe/paths";
import { z } from "astro/zod";
import { GenreList } from "../../../components/infinite-lists/genre-list";
import MediaCardList from "../../../components/media-card-list.astro";
import {
  getMediaByGenre,
  getTMDBContext,
} from "../../../integrations/tmdb/services";
import { mediaIdSchema } from "../../../integrations/valibot/schema";
import Layout from "../../../layouts/layout.astro";

export const prerender = false;

const getData = async () => {
  const parseResult = await z
    .object({ genreId: mediaIdSchema })
    .safeParseAsync(Astro.params);

  if (!parseResult.success) {
    return null;
  }

  const context = getTMDBContext();

  const genreId = parseResult.data.genreId;

  const movies = await getMediaByGenre({
    context,
    genre: genreId,
    media: "movie",
    page: 1,
  });

  return { genreId, movies };
};

const data = await getData();

if (!data) {
  return Astro.redirect(paths.notFound);
}
---

<Layout>
  <GenreList
    genreId={data.genreId}
    mediaType="movie"
    pageCount={data.movies.total_pages}
  >
    <MediaCardList collection={data.movies.results ?? []} />
  </GenreList>
</Layout>
