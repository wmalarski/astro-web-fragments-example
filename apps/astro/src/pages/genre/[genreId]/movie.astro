---
import { paths } from "@awfe/paths";
import { GenreList } from "@components/infinite-lists/genre-list";
import MediaCardList from "@components/media-card-list.astro";
import { tmdb } from "@integrations/tmdb";
import { mediaIdSchema } from "@integrations/valibot/schema";
import Layout from "@layouts/layout.astro";
import { z } from "astro/zod";

export const prerender = false;

const getData = async () => {
  const parseResult = await z
    .object({ genreId: mediaIdSchema })
    .safeParseAsync(Astro.params);

  if (!parseResult.success) {
    return null;
  }

  const context = tmdb.getTMDBContext();

  const genreId = parseResult.data.genreId;

  const movies = await tmdb.getMediaByGenre({
    context,
    genre: genreId,
    media: "movie",
    page: 1,
  });

  return { genreId, movies };
};

const data = await getData();

if (!data) {
  return Astro.redirect(paths.notFound);
}
---

<Layout>
  <GenreList
    client:idle
    genreId={data.genreId}
    mediaType="movie"
    pageCount={data.movies.total_pages}
    name={data.movies.genre?.name}
  >
    <MediaCardList collection={data.movies.results ?? []} />
  </GenreList>
</Layout>
